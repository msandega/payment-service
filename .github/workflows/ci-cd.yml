name: CI/CD - Payments API

on:
  workflow_dispatch: {}                # allows manual runs from Actions -> Run workflow
  push:
    branches: [ "main-default", "trial" ]

env:
  IMAGE_PAYMENT: ranckosolutionsinc/payments-service   # <<-- REPLACE with your image
  IMAGE_TAG: v1.0

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Create a Docker network
        run: docker network create ci-network || true

      - name: Start Mongo (test DB)
        run: |
          docker run -d --name ci-mongo --network ci-network \
            -e MONGO_INITDB_ROOT_USERNAME=mongo \
            -e MONGO_INITDB_ROOT_PASSWORD=password \
            mongo:4.2

      - name: Pull payment image
        run: docker pull ${{ env.IMAGE_PAYMENT }}:${{ env.IMAGE_TAG }}

      - name: Run payment container (test mode)
        env:
          MONGODB_URI: mongodb://mongo:password@ci-mongo:27017/?authSource=admin
        run: |
          docker run -d --name ci-payment --network ci-network \
            -e MONGODB_URI="${MONGODB_URI}" \
            -e INTASEND_PUBLIC_KEY="${{ secrets.CI_INTASEND_PUBLIC_KEY }}" \
            -e INTASEND_SECRET_KEY="${{ secrets.CI_INTASEND_SECRET_KEY }}" \
            -e INTASEND_TEST_MODE=true \
            -p 3663:3663 \
            ${{ env.IMAGE_PAYMENT }}:${{ env.IMAGE_TAG }}

      - name: Wait for payment service
        run: |
          for i in $(seq 1 25); do
            echo "Attempt $i ..."
            curl -sS -m 5 http://localhost:3663/healthz && exit 0 || true
            sleep 3
          done
          echo "Service did not respond within timeout" && exit 1

      - name: Smoke test (internal)
        run: |
          docker run --network ci-network --rm curlimages/curl:latest -sS -D - http://ci-payment:3663/ | sed -n '1,60p'

      - name: Cleanup containers (always)
        if: always()
        run: |
          docker rm -f ci-payment ci-mongo || true
          docker network rm ci-network || true
